# BLE通信机制及协议设计

## 通信协议设计
由于BLE是基于包的协议，因此应用层协议设计也是基于包的，包结构中不包含自身长度的描述；
应用层协议包结构如下表：
|字段|类型|长度(字节)|说明|
|指令枚举|byte|1|当前数据包表示的指令|
|包体|byte|不定长|包内容数据|

## 配置项设计
配置项结构如下表：

|配置项|指令枚举|配置值类型|配置值说明|
|---|---|---|---|
|已配对设备列表|0x01|Array<bytes>|已配对设备的MAC地址|
|RS485通道模式|0x02|Map<byte, byte>|key为RS485通道编号（从0开始）,value为模式枚举|

除通过BLE操作进行读写外，还提供单独的方法用于清空已配对设备列表，一个使用场景是恢复出厂设置按钮被按住5秒时清空出厂设置。

## BLE特性设计
### 设置
特性ID为0xfff0
支持Write/Notify，Write操作为执行指定操作，并通过Notify返回执行结果；

#### 操作
本节中每一小节为一个可以执行的操作，除配对操作外，其他操作仅允许已配对设备执行。
每个操作执行完后均返回确认消息，若操作有返回值则紧随其后。
##### 配对
指令枚举：0x01
参数：蓝牙MAC地址（6字节）
逻辑说明：将指定蓝牙MAC地址加入列表以实现配对；当已配对设备列表为空时，允许任何设备执行，否则仅允许列表内的设备执行。

##### 取消配对
指令枚举：0x02
参数：蓝牙MAC地址（6字节）
逻辑说明：将指定蓝牙MAC地址从已配对设备列表中移除

##### 清空配对
指令枚举：0x03
逻辑说明：清空已配对设备列表

##### 读取配置或状态
指令枚举：0x04
参数：配置枚举（1字节）
逻辑说明：读取指定配置
响应结构：指定配置的值

##### 写入配置
指令枚举：0x05
参数：配置枚举（1字节）+配置值（不定长）

### RS485通信
紧随设置特性有N个RS485通信特性（N=RS485硬件通道数量），支持Write/Notify，Write为按照通道模式配置发送数据，Notify返回按照通道模式配置接收到的数据。
若RS485通道没有设置任何模式，则无响应。
通道模式枚举与模式的对应关系如下表：
|模式枚举|模式|说明|
|---|---|---|
|0x00|未设置||
|0x01|RAW|字节流|
|0x02|Modbus RTU|使用esp-modbus实现|
|0x03|Modbus ASCII|使用esp-modbus实现|